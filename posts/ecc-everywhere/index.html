<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Use ECC everywhere, check your chips - rebeagle</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:image" content><meta property="og:title" content="Use ECC everywhere, check your chips"><meta property="og:description" content="Recently Linus Torvalds was in the news blaming Intel for the lack of ECC memory everywhere. I also recently built my first new workstation in over 5 years. My workstation is literally used for work, my livelihood, so reliability was my top priority. All of my parts were selected for reliability and compatibility with Linux (my workstation runs Ubuntu LTS). One of my specific goals with the Ryzen 3rd gen platform was to use ECC memory. ECC memory is readily available and the extra cost is typically reasonable. However, Ryzen only supports unbuffered ECC DIMMs; not the readily available registered ECC DIMMs. At the time of my build (February 2020), 3200MHz ECC UDIMMs were not available anywhere&mldr; at any cost. I conceded to the situation and bought reputable non-ECC DIMMs: Corsair Vengeance LPX. Big mistake. This is my story."><meta property="og:type" content="article"><meta property="og:url" content="/posts/ecc-everywhere/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-20T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-20T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Use ECC everywhere, check your chips"><meta name=twitter:description content="Recently Linus Torvalds was in the news blaming Intel for the lack of ECC memory everywhere. I also recently built my first new workstation in over 5 years. My workstation is literally used for work, my livelihood, so reliability was my top priority. All of my parts were selected for reliability and compatibility with Linux (my workstation runs Ubuntu LTS). One of my specific goals with the Ryzen 3rd gen platform was to use ECC memory. ECC memory is readily available and the extra cost is typically reasonable. However, Ryzen only supports unbuffered ECC DIMMs; not the readily available registered ECC DIMMs. At the time of my build (February 2020), 3200MHz ECC UDIMMs were not available anywhere&mldr; at any cost. I conceded to the situation and bought reputable non-ECC DIMMs: Corsair Vengeance LPX. Big mistake. This is my story."><script src=/js/feather.min.js></script><link href=/css/fonts.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=/css/main.css><link rel=stylesheet type=text/css href=/css/dark.css media="(prefers-color-scheme: dark)"></head><body><div class=content><header><div class=main><a href=/><img src=/ico.svg style=width:3em></a></div><nav><div><a href=/posts>Posts</a>
<a href=/projects>Projects</a>
<a href=/about>About</a></div>&nbsp;|<div id=icons><a class=soc href=https://github.com/wpbrown title=GitHub><i data-feather=github></i></a></div></nav></header><main><article><div class=title><h1 class=title>Use ECC everywhere, check your chips</h1><div class=meta>Posted on Feb 20, 2021</div></div><section class=body><p>Recently Linus Torvalds was in the <a href=https://arstechnica.com/gadgets/2021/01/linus-torvalds-blames-intel-for-lack-of-ecc-ram-in-consumer-pcs/>news</a> blaming Intel for the lack of ECC memory everywhere. I also recently built my first new workstation in over 5 years. My workstation is literally used for work, my livelihood, so reliability was my top priority. All of my parts were selected for reliability and compatibility with Linux (my workstation runs Ubuntu LTS). One of my specific goals with the Ryzen 3rd gen platform was to use ECC memory. ECC memory is readily available and the extra cost is typically reasonable. However, Ryzen only supports unbuffered ECC DIMMs; not the readily available registered ECC DIMMs. At the time of my build (February 2020), 3200MHz ECC UDIMMs were not available anywhere&mldr; at any cost. I conceded to the situation and bought reputable non-ECC DIMMs: <a href=https://www.amazon.com/gp/product/B016ORTNI2>Corsair Vengeance LPX</a>. Big mistake. This is my story.</p><p>I&rsquo;ve had cognitive dissonance about ECC memory for along time. I used to write software for supercomputers. I was acutely aware of the fallibility of memory modules. Single jobs ran over hundreds to thousands of physical nodes each with >=128GiB of ECC RAM. It was common enough of a problem that we specifically designed for early detection, fault tolerance, and self-healing in the event of memory (among other hardware) failures. But I never experienced bad memory in all my years on my own PCs. I&rsquo;ve been building my own PCs for over 20 years. None of my friends who build PCs had ever confirmed bad memory either. I know memory modules fail in supercomputers and servers, but they don&rsquo;t fail in consumer PCs because&mldr; reasons? The reality is I&rsquo;ve never <em>confirmed</em> bad memory before. If you&rsquo;re not using ECC or thoroughly testing modules, there is no telling if the odd crash or corruption here and there was actually caused by memory errors. Memory problems in consumer <del>PCs</del> electronics are probably far more common than we know.</p><h2 id=the-unraveling>The Unraveling</h2><p>My new workstation build was rock solid for the first couple of months. I was absolutely thrilled. Every once in a while Chromium crashed. I was experiencing a known issue with the snap packaging on Ubuntu because I don&rsquo;t reboot for weeks or months or even close Chromium for that matter. Eventually Snap would force update Chromium binaries while it was running and it would crash. Fast forward a month and my root btrfs file system detects metadata corruption and forces itself to read-only. If you don&rsquo;t reboot in this situation all kinds of things start crashing. Then it happened in 3 weeks, then 2 weeks. I occasionally started getting crashes in Chromium when there was no Snap update. Then the Rust compiler started randomly segfaulting. Rerunning it with no changes would build successfully. Panic was really starting to set in. This workstation is critical to my day job and the issues were starting to grit at my productivity. What of a million things could be wrong? Is it software, hardware, or firmware?</p><p>I&rsquo;ve used btrfs on my NAS (with ECC memory) since 2015 and a bit longer on my workstation. I&rsquo;ve had great success with it. In my NAS I use it in RAID-1 (mirror) configuration with snapshot send/receive to send backups to additional disks. My workstation sends snapshot backups to the NAS multiple times per day. I&rsquo;ve never lost data with btrfs. The file system detecting corruption and going read-only stood out to me as the most obvious &lsquo;this is really bad&rsquo; thing. I wasn&rsquo;t really ready to blame btrfs. I had seen multiple <a href="https://www.youtube.com/watch?v=ywwtQ6kFFIc">rants</a> from Louis Rossman about failing Samsung 970 EVOs. I was using the Samsung 970 EVO Plus. <a href=https://en.wikipedia.org/wiki/Badblocks>badblocks</a> didn&rsquo;t detect problems. The NVME drive self-test would hang indefinitely though. While btrfs scrubs were still coming back clean, my last day of btrfs sends to my NAS had failed. Btrfs send fails upon checksum errors which is good in that it won&rsquo;t send corrupted data to your backups. But why are scrubs (which also check the checksums) passing? I ordered a Crucial P5 SSD to replace the Samsung, despite low confidence this was the issue.</p><p>I wasn&rsquo;t able to btrfs send from the Samsung to the Crucial due to the corruption being detected. Unfortunately btrfs doesn&rsquo;t tell you what files are corrupt. There is a trick though: you can <code>cat</code> all files on the system to <code>/dev/null</code> until you find files that cause <code>cat</code> to error out on read. The corrupt files were not important, so I deleted them and then was able to send my subvolumes over to the new disk. I ran a scrub on the Crucial and everything looked fine. Success! After some reconfiguration of <code>/etc/fstab</code> and reinstalling GRUB on the new drive I was able to reboot in to the Crucial like nothing ever happened. The first regular send to my NAS worked, and I felt relief. However the next morning I came in to an alert that another send failed. Dread! I scrubbed immediately and it detected no corruption. Now I&rsquo;m ready to blame btrfs! <code>btrfs send</code> is detecting corruption but <code>btrfs scrub</code> is not. At some point through all this I upgraded from the GA 5.4 kernel to the HWE 5.8 kernel. Maybe it&rsquo;s 5.8 issue? I booted off a live USB drive using the 5.4 kernel and ran <code>btrfs check</code>. So much corruption! On the Samsung and the Crucial. I ran <code>hashdeep</code> to md5 sum all the files on a backup snapshot on the NAS and them on a snapshot that was still on the Samsung. Everything matched! ಠ_ಠ So <code>btrfs send</code> and <code>btrfs check</code> detect corruption, but <code>hashdeep</code> and <code>btrfs scrub</code> do not. Burn it all down, btrfs sucks. Since I had all my data off the Samsung, so I did the usually risky move and ran <code>btrfs check --repair --init-csum-tree</code>. If the files are good and the checksums are bad, let&rsquo;s just make new checksums, <a href=https://www.reddit.com/r/Whatcouldgowrong/>WCGW</a>! It barfed errors on to the screen for 10 minutes and the file system was rendered completely corrupt. Cool.</p><p><a href=everywhere.jpg target=_blank><img src=everywhere.jpg alt="corruption Toy Story everywhere meme"></a></p><h2 id=memtest86>Memtest86</h2><p>I turned my attention back to the Crucial. I had previously <code>btrfs check</code>ed it and I remembered seeing >5 checksum errors. At this point I was contemplating my life choices. Maybe I should buy a Dell (dude), run Windows, and backup to a WD My Book with the included proprietary software. I ran <code>btrfs check</code> just grasping at straws. There were &lt;5 checksum errors. ಠ_ಠ Wait a minute. I ran <code>btrfs check</code> probably 5 more times. Each time I got a different number of checksum errors. One time I got no errors! While I thought it was conceivable that an SSD could be malfunctioning in such a way that it returns random corruption, it&rsquo;s too improbable for 2 completely different SSDs. It had to be something upstream of the SSD. Given all of my good experience with btrfs and trying 2 different kernel version (1 being an LTS kernel), it also seemed improbable there was something wrong with the software. The thought of ordering new memory, motherboard, and CPU?? to swap in trial-and-error style was just dreadful. The memory seemed like the most likely culprit. I&rsquo;ve had a bad motherboard before and the symptoms are typically more catastrophic. I&rsquo;ve known of <a href=https://www.memtest86.com/>memtest86</a> forever, but I&rsquo;ve never actually used it. I threw it on a USB drive and lo and behold&mldr;</p><p><a href=memtest.jpg target=_blank><img src=memtest.jpg alt="memtest86 screenshot"></a></p><h2 id=nemix>NEMIX?</h2><p>With the benefit of hindsight, the memory being the culprit seems somewhat obvious. However, up until this point for me it was just a random assortment of seemingly unrelated problems. Even this memtest result was not a smoking gun. There could still have been a memory controller issue (in the CPU) or an issue with the motherboard. Only swapping parts would tell. I started with the memory and this time I was determined to use only ECC memory. I searched all the typical channels and found a single vendor in the US with 3200MHz ECC UDIMMs available to order in January 2021: <a href="https://www.amazon.com/gp/product/B08CFVW1HZ/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&psc=1">NEMIX</a>. There were few mentions of this vendor anywhere in the wild, so I ordered 1 pair as a test run. A couple weeks later Linus Tech Tips made <a href="https://www.youtube.com/watch?v=pPeCNrNTr3k">a video</a> about ECC on Ryzen and they not so coincidentally bought the exact same DIMMs. Kingston actually had 32GiB DIMMs for sale direct on their website, but I was concerned about the compatibility with Ryzen, which supports 64GiB total. At the time of this writing (February 2021) they have 16GiB (and not 32GiB DIMMs) available for direct order. I would have purchased those if they were available. If you&rsquo;re reading this on a new Ryzen system without ECC go get them now!</p><p><a href=kingston.png target=_blank><img src=kingston.png alt="Kingston modules for sale"></a></p><p>The first pair of 16GiB DIMMs worked perfectly and passed a full multi-hour memtest run. They identified as Kingston via SPD and had Micron DRAM chips. It&rsquo;s interesting that Micron&rsquo;s own Crucial DIMMs with these chips are out of stock everywhere. I ordered a second kit for a total of 4 16GiB DIMMs. This second kit would not POST, even by themselves. This kit also used Micron DRAM chips. Despite the NEMIX DIMM label saying 3200MHz, the DRAM chips on this DIMM were 2666MHz.</p><p>You can <a href=https://www.micron.com/support/tools-and-utilities/fbga>look up</a> the exact DRAM chip part number based on a code on the chip. The part numbers can be further decoded using the <a href=https://media-www.micron.com/-/media/client/global/documents/products/data-sheet/dram/ddr4/8gb_ddr4_sdram.pdf>datasheet</a>. Were the DIMMs honestly mislabeled or is there some funny business going on? Had they POSTed and just run at the lower speed then I&rsquo;d believe someone just slapped the wrong label on the DIMM. But, if there were funny business going on, one would think they&rsquo;d make some effort to hide the chip identification. In any event, NEMIX replaced the second kit with no fuss. The third kit came with 3200MHz modules and the SPD identified as <a href=https://eng.panram.com.tw/>PANRAM</a>.</p><p><a href=chips.jpg target=_blank><img src=chips.jpg alt="photos of DRAM chips on kits"></a></p><table><thead><tr><th>Kit</th><th>Code</th><th>Micron Part</th><th>Speed Rating</th><th></th></tr></thead><tbody><tr><td>First</td><td>[D9WFL]</td><td>MT40A1G8 SA-062E:E</td><td>3200MHz</td><td></td></tr><tr><td>Second</td><td>[D9VHP]</td><td>MT40A1G8 SA-075:H</td><td>2666MHz</td><td></td></tr><tr><td>Third</td><td>[Z9ZDQ]</td><td>MT40A1G8 JC-062E ES:P</td><td>3200MHz</td><td></td></tr></tbody></table><p>There isn&rsquo;t much information about NEMIX out there. I&rsquo;m not sure how they come in to possession of the most rare DRAM chips in the world with a random assortment of integrator&rsquo;s SPD EEPROMs. They seem to be legit, but it&rsquo;s still a good idea to QC your purchase with MemTest86 and check the chips!</p></section><div class=post-tags></div></article></main><footer><br><hr><a href=/>rebeagle</a></footer><script>feather.replace()</script></div></body></html>